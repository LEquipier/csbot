# CSBOT 进程管理说明

## 🚨 问题背景

当您使用 `Ctrl+C` 关闭 `auto_run.py` 时，可能没有完全终止所有子进程，导致它们在后台继续运行。这会导致：
- 重复的数据库构建
- 资源浪费
- 潜在的进程冲突

## 🛠️ 解决方案

### 1. 改进的 auto_run.py

我们已经改进了 `auto_run.py` 脚本，添加了：
- **信号处理**：正确处理 `Ctrl+C` 信号
- **进程管理**：自动清理子进程
- **优雅关闭**：确保所有资源被正确释放

### 2. 进程管理工具

提供了两个便捷的进程管理脚本：

#### check_processes.py - 简单检查
```bash
python check_processes.py
```
功能：
- 检查当前CSBOT进程状态
- 显示系统资源使用情况
- 提供管理建议

#### process_manager.py - 完整管理
```bash
python process_manager.py
```
功能：
- 查看当前进程
- 终止所有CSBOT进程
- 启动auto_run脚本
- 终止特定进程
- 交互式管理界面

## 📋 使用方法

### 启动服务
```bash
# 智能模式（推荐）
python auto_run.py

# 守护进程模式
python auto_run.py --daemon

# 立即执行模式
python auto_run.py --immediate
```

### 检查进程
```bash
# 快速检查
python check_processes.py

# 完整管理
python process_manager.py
```

### 停止服务
```bash
# 方法1：使用进程管理器
python process_manager.py
# 选择选项2：终止所有CSBOT进程

# 方法2：直接命令
pkill -f 'auto_run\|build_database'

# 方法3：查看PID后手动终止
ps aux | grep "auto_run\|build_database"
kill <PID>
```

## 🔧 改进特性

### 1. 信号处理
- 正确处理 `SIGINT` (Ctrl+C)
- 正确处理 `SIGTERM` (终止信号)
- 优雅关闭所有子进程

### 2. 进程清理
- 自动清理进度条
- 终止子进程
- 等待进程完成或强制终止

### 3. 资源管理
- 防止进程泄漏
- 确保资源正确释放
- 避免僵尸进程

## ⚠️ 注意事项

1. **避免重复运行**：确保同时只有一个 `auto_run.py` 实例在运行
2. **定期检查**：使用进程管理工具定期检查进程状态
3. **优雅关闭**：使用 `Ctrl+C` 或进程管理器来停止服务
4. **监控资源**：注意CPU和内存使用情况

## 🎯 最佳实践

1. **启动前检查**：使用 `python check_processes.py` 检查是否有残留进程
2. **使用守护进程模式**：`python auto_run.py --daemon` 在后台运行
3. **定期维护**：定期使用进程管理器检查和清理进程
4. **监控日志**：查看 `logs/auto_update.log` 了解运行状态

## 🆘 故障排除

### 进程无法终止
```bash
# 强制终止
kill -9 <PID>

# 批量强制终止
pkill -9 -f 'auto_run\|build_database'
```

### 检查进程状态
```bash
# 查看所有Python进程
ps aux | grep python

# 查看CSBOT相关进程
ps aux | grep "CSBOT\|auto_run\|build_database"
```

### 清理日志
```bash
# 查看日志
tail -f logs/auto_update.log

# 清理旧日志
rm logs/auto_update.log.*
```

现在您的系统具备了完整的进程管理功能，可以安全地启动、停止和监控CSBOT服务！
