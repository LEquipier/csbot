# CSQAQ 后端系统详细说明文档

## 📁 项目结构概览

```
backend/
├── app.py                    # Flask主应用服务器
├── config.py                 # 配置文件
├── CSQAQ.py                  # CSQAQ API客户端
├── requirements.txt          # Python依赖包
├── README.md                 # 项目说明文档
└── Model/                    # 数据模型和训练模块
    ├── build_database.py     # 数据库构建脚本
    ├── train.py              # 模型训练脚本
    ├── get_dataset.py        # 数据集获取脚本
    ├── update_database.py    # 数据库更新脚本
    └── dataset/              # 数据存储目录
        ├── 蝴蝶刀_db/        # 蝴蝶刀数据库
        ├── 鲍伊猎刀_db/      # 鲍伊猎刀数据库
        └── ...
```

---

## 🔧 核心配置文件

### `config.py` - 系统配置文件

**文件功能：** 集中管理系统配置参数，包括API Token、请求限制等。

#### 主要变量：
- `API_TOKEN`: CSQAQ API访问令牌
- `BASE_URL`: API基础URL地址
- `QPS`: 每秒请求数限制（默认0.3）
- `TIMEOUT`: 请求超时时间（默认30秒）

#### 主要方法：

##### `validate_config()`
**功能：** 验证配置是否正确
**参数：** 无
**返回值：** `bool` - 配置是否有效
**说明：** 
- 检查API Token是否已设置
- 提供详细的配置指导信息
- 显示Token的前8位和后4位用于验证

**使用示例：**
```python
from config import validate_config
if validate_config():
    print("配置验证通过")
else:
    print("请设置有效的API Token")
```

---

## 🌐 API客户端

### `CSQAQ.py` - CSQAQ API客户端

**文件功能：** 封装CSQAQ API的所有接口调用，提供统一的客户端接口。

#### 主要类：`CsqaqClient`

##### 初始化参数：
- `api_token`: API访问令牌
- `base_url`: API基础URL（默认从config.py读取）
- `qps`: 请求频率限制（默认0.3）
- `timeout`: 请求超时时间（默认30秒）

#### 核心方法：

##### `_headers()`
**功能：** 生成请求头
**返回值：** `Dict` - 包含API Token和Content-Type的请求头

##### `_rate_limit()`
**功能：** 实现请求频率限制
**说明：** 确保请求间隔符合QPS限制

##### `_request(key, params=None, data=None)`
**功能：** 统一的HTTP请求处理
**参数：**
- `key`: 端点标识符
- `params`: GET请求参数
- `data`: POST请求数据
**返回值：** `Dict` - API响应数据
**特性：** 
- 自动重试机制（最多5次）
- 指数退避策略
- 友好的错误提示

#### 指数相关方法：

##### `index_home()`
**功能：** 获取首页指数数据
**返回值：** `Dict` - 包含大盘指数、热门饰品等信息

##### `index_detail(index_id)`
**功能：** 获取指定指数详情
**参数：** `index_id` - 指数ID
**返回值：** `Dict` - 指数详细信息

##### `index_kline(index_id, period="1day", start=None, end=None)`
**功能：** 获取指数K线数据
**参数：**
- `index_id`: 指数ID
- `period`: 时间周期（1hour/1day/1week/1month）
- `start`: 开始时间戳
- `end`: 结束时间戳
**返回值：** `Dict` - K线数据

#### 饰品相关方法：

##### `get_good_id(search, page_index=1, page_size=20)`
**功能：** 搜索饰品ID
**参数：**
- `search`: 搜索关键词
- `page_index`: 页码
- `page_size`: 每页数量
**返回值：** `Dict` - 搜索结果

##### `search_suggest(text)`
**功能：** 饰品名称联想查询
**参数：** `text` - 输入文本
**返回值：** `Dict` - 联想建议列表

##### `good_detail(good_id)`
**功能：** 获取饰品详情
**参数：** `good_id` - 饰品ID
**返回值：** `Dict` - 饰品详细信息

##### `batch_price(market_hash_names)`
**功能：** 批量获取饰品价格
**参数：** `market_hash_names` - 饰品名称列表
**返回值：** `Dict` - 批量价格数据

##### `good_chart(good_id, key, platform=1, period="1095", style="all_style")`
**功能：** 获取饰品图表数据
**参数：**
- `good_id`: 饰品ID
- `key`: 数据类型（sell_price/buy_price/sell_num/buy_num）
- `platform`: 平台ID（1=BUFF, 2=YYYP, 3=Steam）
- `period`: 时间周期（默认1095天）
- `style`: 数据样式
**返回值：** `Dict` - 图表数据

#### 成交数据方法：

##### `vol_data_info()`
**功能：** 获取实时交易量数据信息
**返回值：** `Dict` - 成交量数据概览

##### `vol_data_detail(vol_id, is_weapon, start_day)`
**功能：** 获取成交量图表和磨损信息
**参数：**
- `vol_id`: 成交量标识
- `is_weapon`: 是否为武器
- `start_day`: 起始日期（YYYY-MM-DD格式）
**返回值：** `Dict` - 详细成交量数据

#### 排行榜和列表方法：

##### `get_rank_list(page_index=1, page_size=15, show_recently_price=False, filter_dict=None)`
**功能：** 获取排行榜信息
**参数：**
- `page_index`: 页码
- `page_size`: 每页数量
- `show_recently_price`: 是否显示最近价格
- `filter_dict`: 过滤条件
**返回值：** `Dict` - 排行榜数据

##### `get_page_list(page_index=1, page_size=18, search="", filter_dict=None)`
**功能：** 获取饰品列表
**参数：**
- `page_index`: 页码
- `page_size`: 每页数量
- `search`: 搜索关键词
- `filter_dict`: 过滤条件
**返回值：** `Dict` - 饰品列表数据

##### `get_series_list()`
**功能：** 获取热门系列饰品列表
**返回值：** `Dict` - 系列列表

##### `get_series_detail(series_id)`
**功能：** 获取系列详情
**参数：** `series_id` - 系列ID
**返回值：** `Dict` - 系列详细信息

##### `get_popular_goods()`
**功能：** 获取热门饰品排名
**返回值：** `Dict` - 前500件热门饰品

#### 挂刀行情方法：

##### `exchange_detail(page_index=1, res=0, platforms="BUFF-YYYP", sort_by=1, min_price=1, max_price=5000, turnover=10)`
**功能：** 获取挂刀行情详情
**参数：**
- `page_index`: 页码
- `res`: 分辨率/筛选条件
- `platforms`: 平台组合
- `sort_by`: 排序方式
- `min_price`: 最低价格
- `max_price`: 最高价格
- `turnover`: 成交量要求
**返回值：** `Dict` - 挂刀机会数据

---

## 🚀 Web应用服务器

### `app.py` - Flask主应用

**文件功能：** 提供Web API接口，连接前端界面和CSQAQ API，支持跨域请求和交易建议。

#### 主要函数：

##### `create_app()`
**功能：** 创建Flask应用实例
**返回值：** `Flask` - 配置好的Flask应用
**配置：**
- 模板目录：`../frontend/templates`
- 静态文件目录：`../frontend/static`
- 支持中文JSON响应
- CORS跨域支持：允许所有来源访问API接口

##### `create_client()`
**功能：** 创建CSQAQ客户端
**返回值：** `CsqaqClient` - API客户端实例

#### 依赖包：
```bash
pip install flask flask-cors
```

#### API路由：

##### `@app.route('/')`
**功能：** 主页路由
**返回：** HTML页面

##### `@app.route('/api/dashboard')`
**功能：** 获取仪表板数据
**返回：** JSON格式的仪表板数据
**包含：**
- 大盘指数数据
- 热门饰品列表
- 成交数据概览

##### `@app.route('/api/search')`
**功能：** 搜索饰品
**参数：**
- `q`: 搜索关键词
- `page`: 页码
- `size`: 每页数量
**返回：** JSON格式的搜索结果

##### `@app.route('/api/item/<int:item_id>')`
**功能：** 获取饰品详情
**参数：** `item_id` - 饰品ID
**返回：** JSON格式的饰品详情和图表数据

##### `@app.route('/api/rankings')`
**功能：** 获取排行榜数据
**参数：**
- `page`: 页码
- `size`: 每页数量
**返回：** JSON格式的排行榜数据

##### `@app.route('/api/series')`
**功能：** 获取热门系列
**返回：** JSON格式的系列列表

##### `@app.route('/api/series/<int:series_id>')`
**功能：** 获取系列详情
**参数：** `series_id` - 系列ID
**返回：** JSON格式的系列详情

##### `@app.route('/api/exchange')`
**功能：** 获取挂刀机会
**参数：**
- `min_price`: 最低价格
- `max_price`: 最高价格
- `turnover`: 成交量要求
**返回：** JSON格式的挂刀机会列表（包含利润率计算）

##### `@app.route('/api/volume')`
**功能：** 获取成交数据
**返回：** JSON格式的成交量数据

##### `@app.route('/api/volume/<int:vol_id>')`
**功能：** 获取成交详情
**参数：** `vol_id` - 成交量ID
**返回：** JSON格式的成交详情

##### `@app.route('/api/kline/index/<int:index_id>')`
**功能：** 获取大盘指数K线图数据
**参数：**
- `index_id`: 指数ID
- `period`: 时间周期
- `start`: 开始时间
- `end`: 结束时间
**返回：** JSON格式的K线数据

##### `@app.route('/api/kline/item/<int:item_id>')`
**功能：** 获取单一饰品K线图数据
**参数：**
- `item_id`: 饰品ID
- `key`: 数据类型
- `platform`: 平台ID
- `period`: 时间周期
- `style`: 数据样式
**返回：** JSON格式的K线数据

##### `@app.route('/api/suggest')`
**功能：** 饰品名称联想搜索
**参数：** `text` - 输入文本
**返回：** JSON格式的联想建议

##### `@app.route('/api/recommendation')`
**功能：** 获取交易建议（新增）
**返回：** JSON格式的交易建议
**包含：**
- 买入建议列表（基于策略评分）
- 卖出建议列表
- 建议生成时间
- 建议状态信息
**数据来源：** `backend/results/recommendation.json`

#### 错误处理：

##### `@app.errorhandler(404)`
**功能：** 处理404错误
**返回：** JSON格式的错误信息

##### `@app.errorhandler(500)`
**功能：** 处理500错误
**返回：** JSON格式的错误信息

---

## 📊 数据模型模块

### `Model/build_database.py` - 数据库构建脚本

**文件功能：** 构建刀型数据库，包括单品数据、板块数据和多普勒系列处理。

#### 主要类：`KnifeDatabaseBuilder`

##### 初始化参数：
- `api_token`: API访问令牌

#### 核心方法：

##### `fetch_knife_universe(knife_type, keywords, max_pages=8, page_size=50, test_mode=False, max_items=10)`
**功能：** 获取指定刀型的商品ID列表
**参数：**
- `knife_type`: 刀型名称
- `keywords`: 搜索关键词列表
- `max_pages`: 最大搜索页数
- `page_size`: 每页数量
- `test_mode`: 测试模式
- `max_items`: 测试模式下的最大物品数量
**返回值：** `List[str]` - 商品ID列表

##### `fetch_item_panel(good_id, platforms=DEFAULT_PLATFORMS, chart_keys=CHART_KEYS, period="1095", style="all_style", max_retries=6)`
**功能：** 获取单品时间序列数据
**参数：**
- `good_id`: 商品ID
- `platforms`: 平台列表
- `chart_keys`: 图表数据类型
- `period`: 时间周期
- `style`: 数据样式
- `max_retries`: 最大重试次数
**返回值：** `pd.DataFrame` - 时间序列数据

##### `add_price_tech_features(df, price_col, prefix)`
**功能：** 添加价格技术指标
**参数：**
- `df`: 数据框
- `price_col`: 价格列名
- `prefix`: 指标前缀
**返回值：** `pd.DataFrame` - 添加技术指标后的数据框
**添加的指标：**
- 收益率（1日、3日、7日、14日）
- 波动率（7日、14日）
- 移动平均线（5日、20日）
- 布林带指标
- RSI指标

##### `add_cross_platform_features(df)`
**功能：** 添加跨平台特征
**参数：** `df` - 数据框
**返回值：** `pd.DataFrame` - 添加跨平台特征后的数据框
**添加的特征：**
- 平台间价格差异
- 平台间价格比率
- 流动性比率

##### `build_knife_database(knife_type, keywords, test_mode=False, max_items=10)`
**功能：** 构建指定刀型的数据库
**参数：**
- `knife_type`: 刀型名称
- `keywords`: 搜索关键词
- `test_mode`: 测试模式
- `max_items`: 最大物品数量
**返回值：** `Tuple[pd.DataFrame, Dict]` - 面板数据和物品数据库

##### `split_doppler_items(items, good_details)`
**功能：** 将多普勒系列物品分割为独立的Phase物品
**参数：**
- `items`: 物品列表
- `good_details`: 物品详情字典
**返回值：** `List[Dict]` - 分割后的物品列表

##### `create_board_data(df)`
**功能：** 创建板块级数据
**参数：** `df` - 面板数据
**返回值：** `pd.DataFrame` - 板块级数据
**包含的指标：**
- 价格统计（均值、中位数、标准差、最值）
- 交易量统计
- 活跃物品数量
- 价格分布统计
- 流动性指标

##### `calculate_board_technical_indicators(df)`
**功能：** 计算板块技术指标
**参数：** `df` - 板块数据
**返回值：** `pd.DataFrame` - 添加技术指标后的板块数据
**添加的指标：**
- 移动平均线
- 价格位置
- 收益率
- 波动率
- 布林带
- RSI
- 最大回撤

##### `save_knife_database(knife_type, panel_df, items_db, board_df)`
**功能：** 保存刀型数据库
**参数：**
- `knife_type`: 刀型名称
- `panel_df`: 面板数据
- `items_db`: 物品数据库
- `board_df`: 板块数据
**保存的文件：**
- `{knife_type}_items_database.json`: 物品数据库
- `{knife_type}_panel.csv`: 面板数据
- `{knife_type}_board.csv`: 板块数据
- `items/`目录下的单品CSV文件

##### `run(knife_types=None, test_mode=False, max_items=10)`
**功能：** 运行完整的数据库构建流程
**参数：**
- `knife_types`: 刀型列表（默认全部）
- `test_mode`: 测试模式
- `max_items`: 最大物品数量
**返回值：** `Dict` - 构建结果统计

#### 命令行参数：
- `--token`: API Token
- `--knives`: 指定要构建的刀型
- `--dataset-dir`: 数据集目录
- `--test`: 测试模式
- `--max-items`: 测试模式下的最大物品数量

### `Model/train.py` - 模型训练脚本

**文件功能：** 实现多臂老虎机（Multi-Armed Bandit）交易策略的训练和回测。

#### 主要配置常量：
- `SCRIPT_DIR`: 脚本所在目录（自动获取）
- `DATA_DIR`: 数据目录路径（自动解析为绝对路径）
- `TRAIN_START/TRAIN_END`: 训练期时间范围（2023-01-01 ~ 2024-12-31）
- `TEST_START`: 测试期开始时间（2025-01-01）
- `MAX_HOLD_DAYS`: 最大持仓天数（100天）
- `SELL_FEE_RATE`: 卖出手续费率（2%）
- `SLIP_BUY/SLIP_SELL`: 买卖滑点（0.3%）
- `MAX_NEW_BUYS_PER_DAY`: 每日最多新开仓数量（3个）
- `MAX_POSITIONS`: 并发持仓上限（30个）

#### 核心函数：

##### `load_all_items(data_dir)`
**功能：** 加载所有物品数据
**参数：** `data_dir` - 数据目录
**返回值：** `pd.DataFrame` - 合并后的所有物品数据
**特性：**
- 自动创建good_id到中文名称的映射
- 添加item_name列，包含中文名称
- 处理价格数据清洗（0值转为NaN）
- 支持UTF-8和GBK编码

##### `compute_features(raw_data)`
**功能：** 计算特征指标
**参数：** `raw_data` - 原始数据
**返回值：** `pd.DataFrame` - 包含特征的数据框
**计算的特征：**
- 1日、7日、30日收益率
- 14日波动率
- 价格位置指标
- 技术指标

##### `adaptive_backtest(feat_df, init_state=None)`
**功能：** 自适应回测（多臂老虎机策略）
**参数：**
- `feat_df`: 特征数据
- `init_state`: 初始状态
**返回值：** `Tuple` - 回测结果（摘要、交易记录、权益曲线、策略面板、平台面板）

##### `resolve_cutoff_date()`
**功能：** 解析截止日期
**返回值：** `datetime` - 截止日期

##### `run()`
**功能：** 主运行函数
**命令行参数：**
- `--seed`: 随机种子
- `--run_index`: 当天第几次运行
- `--state_path`: bandit状态快照路径
**输出文件：**
- `../results/trades_training_adaptive.csv`: 训练期交易记录
- `../results/equity_training_adaptive.csv`: 训练期权益曲线
- `../results/trades_test_adaptive.csv`: 测试期交易记录
- `../results/equity_test_adaptive.csv`: 测试期权益曲线
**特性：**
- 自动创建results目录
- item_name字段包含中文名称而非good_id
- 支持热启动状态保存和加载
- 路径自适应：支持从任何目录运行
- 绝对路径解析：确保数据文件正确加载

### `Model/get_dataset.py` - 数据集获取脚本

**文件功能：** 构建蝴蝶刀板块的短线训练数据，融合多平台多指标数据。

#### 主要配置：
- `PLATFORM_MAP`: 平台映射
- `PLATFORM_FEES_SELL/BUY`: 平台费率
- `MIN_HOLD_DAYS`: 最小持仓天数
- `LABEL_HORIZON`: 标签时间范围
- `TAKE_PROFIT_PCT/STOP_LOSS_PCT`: 止盈止损比例

#### 核心函数：

##### `fetch_index_kline(client, index_id=1, k_type="1day")`
**功能：** 获取指数K线数据
**参数：**
- `client`: CSQAQ客户端
- `index_id`: 指数ID
- `k_type`: K线类型
**返回值：** `pd.DataFrame` - 指数K线数据

##### `fetch_vol_data_info(client)`
**功能：** 获取成交量数据信息
**参数：** `client` - CSQAQ客户端
**返回值：** `pd.DataFrame` - 成交量数据

##### `fetch_vol_data_detail(client, vol_id, is_weapon, start_day)`
**功能：** 获取成交量详情数据
**参数：**
- `client`: CSQAQ客户端
- `vol_id`: 成交量ID
- `is_weapon`: 是否为武器
- `start_day`: 开始日期
**返回值：** `pd.DataFrame` - 成交量详情

##### `fetch_butterfly_universe(client, max_pages=8, page_size=50)`
**功能：** 获取蝴蝶刀商品列表
**参数：**
- `client`: CSQAQ客户端
- `max_pages`: 最大页数
- `page_size`: 每页数量
**返回值：** `List[str]` - 商品ID列表

##### `build_butterfly_board_panel(client, max_items=None, test_mode=False)`
**功能：** 构建蝴蝶刀板块面板数据
**参数：**
- `client`: CSQAQ客户端
- `max_items`: 最大物品数量
- `test_mode`: 测试模式
**返回值：** `pd.DataFrame` - 板块面板数据

### `Model/update_database.py` - 数据库更新脚本

**文件功能：** 增量更新数据库，支持智能检测和重新计算。

#### 主要类：`DatabaseUpdater`

##### 核心方法：

##### `load_existing_database(knife_type)`
**功能：** 加载现有的数据库
**参数：** `knife_type` - 刀型名称
**返回值：** `Tuple[Dict, pd.DataFrame, pd.DataFrame]` - 物品数据库、面板数据、板块数据

##### `check_data_freshness(panel_df, days_back=7)`
**功能：** 检查数据新鲜度
**参数：**
- `panel_df`: 面板数据
- `days_back`: 检查天数
**返回值：** `bool` - 是否需要更新

##### `update_item_data(good_id, start_date=None, end_date=None)`
**功能：** 更新单品数据
**参数：**
- `good_id`: 商品ID
- `start_date`: 开始日期
- `end_date`: 结束日期
**返回值：** `pd.DataFrame` - 更新的数据

##### `update_knife_database(knife_type, days_back=7, force=False)`
**功能：** 更新刀型数据库
**参数：**
- `knife_type`: 刀型名称
- `days_back`: 更新天数
- `force`: 强制更新
**返回值：** `bool` - 更新是否成功

##### `run(knife_types=None, days_back=7, force=False, test_mode=False)`
**功能：** 运行数据库更新
**参数：**
- `knife_types`: 刀型列表
- `days_back`: 更新天数
- `force`: 强制更新
- `test_mode`: 测试模式
**返回值：** `Dict` - 更新结果统计

#### 命令行参数：
- `--knives`: 指定要更新的刀型
- `--days`: 更新天数
- `--force`: 强制更新
- `--test`: 测试模式

---

## 📋 使用示例

### 1. 构建蝴蝶刀数据库
```bash
cd backend/Model
python build_database.py --knives 蝴蝶刀 --test --max-items 10
```

### 2. 训练交易模型
```bash
# 从项目根目录运行
python backend/Model/train.py --seed 42 --run_index 1

# 或从Model目录运行
cd backend/Model
python train.py --seed 42 --run_index 1
```
**输出结果：**
- 训练期表现：胜率79%，总收益21,090元
- 测试期表现：胜率89.7%，总收益14,346元
- 结果文件保存在 `backend/results/` 目录
**路径特性：**
- 支持从任何目录运行，自动解析正确路径
- 使用绝对路径确保数据文件正确加载

### 3. 更新数据库
```bash
cd backend/Model
python update_database.py --knives 蝴蝶刀 --days 7
```

### 4. 启动Web服务器
```bash
cd backend
python app.py
```
**访问地址：** http://localhost:5000
**特性：**
- CORS支持：允许跨域请求，兼容iOS/前端应用
- 错误处理：完善的异常捕获和错误响应
- 日志记录：详细的API调用日志
- 自动重试：网络请求失败时自动重试机制

### 5. 获取数据集
```bash
cd backend/Model
python get_dataset.py --test
```

### 6. 自动化运行（新增）
```bash
cd backend
# 单次运行：更新数据库 + 训练模型 + 生成建议
python auto_run.py --once

# 常驻模式：每日3次自动执行（09:05, 13:05, 18:05）
python auto_run.py --daemon

# 自定义建议数量
python auto_run.py --once --topk 5
```
**功能：**
- 自动构建数据库（首次运行）
- 增量更新数据库
- 运行模型训练
- 生成交易建议
- 支持定时执行

---

## 🔧 依赖包

### `requirements.txt`
```
flask>=2.0.0
flask-cors>=6.0.0
requests>=2.25.0
tenacity>=8.0.0
pandas>=1.3.0
numpy>=1.21.0
matplotlib>=3.4.0
tqdm>=4.62.0
python-dateutil>=2.8.0
pyarrow>=6.0.0
fastparquet>=0.8.0
apscheduler>=3.11.0
pytz>=2023.3
```

---

## 📊 数据格式说明

### 面板数据格式（panel.csv）
- `good_id`: 商品ID
- `date`: 日期
- `BUFF_sell_price`: BUFF平台售价
- `BUFF_buy_price`: BUFF平台求购价
- `YYYP_sell_price`: YYYP平台售价
- `YYYP_buy_price`: YYYP平台求购价
- `Steam_sell_price`: Steam平台售价
- `Steam_buy_price`: Steam平台求购价
- 各种技术指标列

### 板块数据格式（board.csv）
- `date`: 日期
- `BUFF_sell_price_mean`: BUFF售价均值
- `BUFF_sell_price_median`: BUFF售价中位数
- `active_items`: 活跃物品数量
- `liquidity_ratio`: 流动性比率
- 各种板块技术指标

### 物品数据库格式（items_database.json）
```json
{
  "good_id": {
    "good_id": "商品ID",
    "name": "商品名称",
    "market_hash_name": "市场哈希名称",
    "rarity": "稀有度",
    "type": "类型",
    "weapon": "武器类型",
    "exterior": "外观",
    "collection": "收藏品",
    "category": "类别",
    "last_updated": "最后更新时间"
  }
}
```

---

## 🚨 注意事项

1. **API限制：** 注意QPS限制，避免触发429错误
2. **数据质量：** 定期检查数据完整性和准确性
3. **存储空间：** 大量数据可能占用较多存储空间
4. **网络连接：** 确保网络连接稳定，API调用可能较慢
5. **配置验证：** 运行前务必验证API Token配置
6. **依赖包安装：** 确保所有依赖包正确安装，特别是flask-cors和apscheduler
7. **路径问题：** train.py支持从任何目录运行，自动解析正确路径
8. **CORS配置：** 如需限制跨域访问，可修改CORS配置中的origins参数

---

## 📞 技术支持

如遇到问题，请检查：
1. API Token是否正确配置
2. 网络连接是否正常
3. 依赖包是否完整安装
4. 数据目录权限是否正确

更多详细信息请参考各文件的注释和文档。

---

## 🤖 自动化脚本

### `auto_run.py` - 自动化主控脚本

**文件功能：** 自动化执行完整的数据库更新、模型训练和交易建议生成流程。

#### 主要配置：
- `KNIFE_TYPES`: 要构建/更新的刀型列表（["蝴蝶刀", "鲍伊猎刀"]）
- `UPDATE_DAYS`: 每次更新最近N天（默认3天）
- `TOPK_BUYS`: 当次最多输出的买入建议数（默认3个）
- `MIN_PRICE`: 有效价格下限（默认1.0）
- `PLATFORMS`: 只考虑的平台（["BUFF", "YYYP"]）

#### 核心函数：

##### `run_py(script, args)`
**功能：** 运行Python脚本
**参数：**
- `script`: 脚本路径
- `args`: 命令行参数
**返回值：** `Tuple[int, str, str]` - 返回码、标准输出、标准错误

##### `load_all_item_csvs(dataset_root)`
**功能：** 读取所有物品CSV文件
**参数：** `dataset_root` - 数据集根目录
**返回值：** `Dict[str, pd.DataFrame]` - 物品名称到数据框的映射

##### `add_basic_features(df)`
**功能：** 添加基础特征
**参数：** `df` - 数据框
**返回值：** `pd.DataFrame` - 添加特征后的数据框
**添加的特征：**
- 1日、7日、30日收益率
- 14日波动率

##### `score_candidate(r1, r7, r30, vol)`
**功能：** 计算候选评分
**参数：**
- `r1`: 1日收益率
- `r7`: 7日收益率
- `r30`: 30日收益率
- `vol`: 波动率
**返回值：** `float` - 评分

##### `make_recommendation(items, topk=3)`
**功能：** 生成交易建议
**参数：**
- `items`: 物品数据字典
- `topk`: 最多建议数量
**返回值：** `Dict` - 交易建议
**包含：**
- 买入建议列表
- 卖出建议列表
- 建议生成时间
- 建议状态信息

##### `ensure_database_built()`
**功能：** 确保数据库已构建
**说明：** 检查标记文件，如果不存在则构建数据库

##### `update_database()`
**功能：** 增量更新数据库
**说明：** 调用update_database.py脚本

##### `run_training()`
**功能：** 运行模型训练
**说明：** 调用train.py脚本

##### `run_once_and_recommend(topk=3)`
**功能：** 执行一次完整流程
**参数：** `topk` - 建议数量
**返回值：** `Dict` - 建议结果
**流程：**
1. 确保数据库已构建
2. 更新数据库
3. 运行训练
4. 生成建议
5. 保存到recommendation.json

##### `run_daemon()`
**功能：** 常驻模式运行
**说明：** 使用APScheduler定时执行，每日3次（09:05, 13:05, 18:05）

#### 命令行参数：
- `--once`: 立刻执行一次
- `--daemon`: 作为常驻服务运行
- `--topk`: 当次最多输出的买入建议数

#### 输出文件：
- `backend/results/recommendation.json`: 交易建议文件

#### 依赖包：
```bash
pip install apscheduler pytz
```

#### 使用示例：
```bash
# 单次运行
python auto_run.py --once --topk 5

# 常驻模式
python auto_run.py --daemon

# 查看帮助
python auto_run.py --help
```

#### 特性：
- 自动化流程：无需手动干预
- 智能检测：自动判断是否需要构建数据库
- 定时执行：支持定时任务
- 错误处理：完善的异常处理机制
- 日志记录：详细的操作日志
